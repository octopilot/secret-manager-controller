---
# SecretManagerConfig for IDAM Service - Development Environment
#
# This example configures the Secret Manager Controller to sync secrets
# from the IDAM microservice's development deployment configuration to
# Google Cloud Secret Manager.
#
# Prerequisites:
# 1. A Flux GitRepository resource named "pricewhisperer-manifests" in the "flux-system" namespace
# 2. The GitRepository should point to the PriceWhisperer repository
# 3. GCP project with Secret Manager API enabled
# 4. Service account with Secret Manager Admin role
#
# Directory structure expected:
# microservices/idam/deployment-configuration/profiles/dev/
#   ├── application.properties      # Non-sensitive config
#   └── application.secrets.env      # SOPS-encrypted secrets
#
# Secrets will be synced to GCP Secret Manager with names:
# - idam-dev-supabase-anon-key
# - idam-dev-jwt-secret
# - idam-dev-supabase-service-role-key
# - idam-dev-properties (all properties as JSON)

apiVersion: secret-management.microscaler.io/v1
kind: SecretManagerConfig
metadata:
  name: idam-dev-secrets
  namespace: pricewhisperer
spec:
  # Source reference - supports FluxCD GitRepository and ArgoCD Application
  # This example uses FluxCD GitRepository
  sourceRef:
    kind: GitRepository  # FluxCD GitRepository
    name: pricewhisperer-manifests
    namespace: flux-system
  
  # Cloud provider configuration
  provider:
    type: gcp
    gcp:
      projectId: pricewhisperer-dev
    # Optional: GCP authentication configuration
    # If not specified, defaults to JSON credentials from GOOGLE_APPLICATION_CREDENTIALS
    # For Workload Identity (recommended for GKE):
    # auth:
    #   authType: WorkloadIdentity
    #   serviceAccountEmail: secret-manager-controller@pricewhisperer-dev.iam.gserviceaccount.com
    # For JSON credentials from a different secret:
    # auth:
    #   authType: JsonCredentials
    #   secretName: custom-gcp-credentials
    #   secretNamespace: microscaler-system
    #   secretKey: key.json
  
  # Secrets sync configuration
  secrets:
    # Environment/profile name to sync (must match directory name under profiles/)
    # This explicitly specifies which environment to process
    environment: dev
    # Base path in the Git repository (optional)
    # If not specified, searches from repository root
    # Examples: "microservices", "services", "apps", or omit for root
    basePath: microservices
    # Optional: Prefix for secret names in GCP Secret Manager
    # If not specified, defaults to the service name from the path
    prefix: idam-dev
    # Optional: Suffix for secret names in GCP Secret Manager
    # Matches kustomize-google-secret-manager suffix behavior for drop-in replacement
    # Example: "-prod", "-be-gcw1", etc.
    # suffix: -prod

