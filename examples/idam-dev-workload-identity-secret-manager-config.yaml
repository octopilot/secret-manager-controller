---
# SecretManagerConfig for IDAM Service - Development Environment (Workload Identity)
#
# This example shows how to configure the controller using Workload Identity
# instead of JSON credentials. This is the recommended approach for GKE clusters.
#
# Prerequisites:
# 1. GKE cluster with Workload Identity enabled
# 2. GCP service account created with Secret Manager Admin role
# 3. Workload Identity binding configured:
#    gcloud iam service-accounts add-iam-policy-binding \
#      SECRET_MANAGER_SA@PROJECT_ID.iam.gserviceaccount.com \
#      --role roles/iam.workloadIdentityUser \
#      --member "serviceAccount:PROJECT_ID.svc.id.goog[microscaler-system/secret-manager-controller]"
# 4. Service account annotation set in config/rbac/serviceaccount.yaml:
#    iam.gke.io/gcp-service-account: SECRET_MANAGER_SA@PROJECT_ID.iam.gserviceaccount.com
# 5. FluxCD GitRepository resource named "mysystem-manifests" in "flux-system" namespace
# 6. GCP project with Secret Manager API enabled
#
# Directory structure expected:
# microservices/myapp/deployment-configuration/profiles/dev/
#   ├── kustomization.yaml      # Contains secretGenerator configuration
#   ├── application.properties
#   └── application.secrets.env  # SOPS-encrypted secrets

apiVersion: secret-management.microscaler.io/v1beta1
kind: SecretManagerConfig
metadata:
  name: myapp-dev-secrets-wi
  namespace: mysystem
spec:
  # Source reference - FluxCD GitRepository
  sourceRef:
    kind: GitRepository
    name: mysystem-manifests
    namespace: flux-system
  
  # Cloud provider configuration
  provider:
    type: gcp
    gcp:
      projectId: mysystem-dev
      # GCP authentication using Workload Identity
      # This is the recommended approach for GKE clusters
      auth:
        authType: WorkloadIdentity
        serviceAccountEmail: secret-manager-controller@mysystem-dev.iam.gserviceaccount.com
  
  # Secrets sync configuration
  secrets:
    # Environment/profile name to sync (must match directory name under profiles/)
    environment: dev
    # Kustomize path - path to kustomization.yaml (relative to Git repository root)
    # Controller will run `kustomize build` on this path and extract secrets
    kustomizePath: microservices/myapp/deployment-configuration/profiles/dev
    # Secret name prefix for GCP Secret Manager
    prefix: myapp-dev
    # Optional: Secret suffix
    # suffix: -prod

