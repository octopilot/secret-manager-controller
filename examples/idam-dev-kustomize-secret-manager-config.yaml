---
# SecretManagerConfig for IDAM Service - Development Environment (Kustomize Mode)
#
# This example uses kustomize build mode to extract secrets from the generated
# Kubernetes Secret resources. This supports kustomize overlays, patches, and generators.
# Works with any GitOps tool (FluxCD, ArgoCD, etc.)
#
# Prerequisites:
# 1. A Flux GitRepository resource named "pricewhisperer-manifests" in the "flux-system" namespace
# 2. The GitRepository should point to the PriceWhisperer repository
# 3. GCP project with Secret Manager API enabled
# 4. Service account with Secret Manager Admin role
# 5. kustomize binary must be available in the controller container
#
# Directory structure expected:
# microservices/idam/deployment-configuration/profiles/dev/
#   ├── kustomization.yaml      # Contains secretGenerator configuration
#   ├── application.properties
#   └── application.secrets.env  # SOPS-encrypted secrets
#
# The controller will run `kustomize build` on the specified path and extract
# secrets from the generated Secret resources. This ensures overlays, patches,
# and generator modifications are included.
#
# Secrets will be synced to GCP Secret Manager with names:
# - idam-dev-supabase-anon-key
# - idam-dev-jwt-secret
# - idam-dev-supabase-service-role-key

apiVersion: secret-management.microscaler.io/v1
kind: SecretManagerConfig
metadata:
  name: idam-dev-secrets-kustomize
  namespace: pricewhisperer
spec:
  # Source reference - supports FluxCD GitRepository and ArgoCD Application
  # This example uses FluxCD GitRepository
  sourceRef:
    kind: GitRepository  # FluxCD GitRepository
    name: pricewhisperer-manifests
    namespace: flux-system
  
  # GCP project ID where secrets will be stored
  gcpProjectId: pricewhisperer-dev
  
  # Environment/profile name to sync (must match directory name under profiles/)
  # This explicitly specifies which environment to process
  environment: dev
  
  # Kustomize path - path to kustomization.yaml (relative to GitRepository root)
  # Controller will run `kustomize build` on this path and extract secrets
  # from the generated Secret resources
  kustomizePath: microservices/idam/deployment-configuration/profiles/dev
  
  # Secret name prefix for GCP Secret Manager
  secretPrefix: idam-dev

