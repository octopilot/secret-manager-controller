---
# SecretManagerConfig - Example Configuration
# This configures the Secret Manager Controller to sync secrets from Git to cloud providers
#
# Prerequisites:
# 1. Flux GitRepository created (see sample-flux-gitrepository.yaml)
# 2. SOPS private key secret created (see below)
# 3. Cloud provider credentials configured (Workload Identity, IRSA, etc.)

apiVersion: secret-management.microscaler.io/v1
kind: SecretManagerConfig
metadata:
  name: my-service-secrets-dev
  namespace: default  # Namespace where secrets will be synced
spec:
  # Source reference - points to Flux GitRepository
  sourceRef:
    kind: GitRepository
    name: my-service-repo
    namespace: flux-system
  
  # Environment/profile to sync (must match directory name under profiles/)
  environment: dev
  
  # Secret prefix - all secrets will be prefixed with this
  secretPrefix: my-service
  
  # Optional: Base path in repository (defaults to root)
  # For single service at root: omit or use "."
  # For monolith: specify path like "microservices/my-service"
  # basePath: "."
  
  # Optional: Kustomize build mode (if using kustomize)
  # buildMode: kustomize
  # kustomizePath: deployment-configuration/profiles/dev
  
  # Cloud Provider Configuration
  # Choose one: AWS, GCP, or Azure
  
  # Option 1: GCP Configuration
  provider:
    type: gcp
    gcp:
      projectId: my-gcp-project-dev
      # Optional: Workload Identity configuration
      # auth:
      #   authType: WorkloadIdentity
      #   serviceAccountEmail: secret-manager@my-gcp-project-dev.iam.gserviceaccount.com
  
  # Option 2: AWS Configuration
  # provider:
  #   type: aws
  #   aws:
  #     region: us-east-1
  #     # Optional: IRSA configuration
  #     # auth:
  #     #   irsa:
  #     #     roleArn: arn:aws:iam::123456789012:role/secret-manager-role
  
  # Option 3: Azure Configuration
  # provider:
  #   type: azure
  #   azure:
  #     vaultName: my-key-vault-dev
  #     # Optional: Workload Identity configuration
  #     # auth:
  #     #   workloadIdentity:
  #     #     clientId: 12345678-1234-1234-1234-123456789012
  
  # Config Store Configuration (optional)
  # When enabled, application.properties are synced to config stores
  # instead of being stored as a JSON blob in secret stores
  configs:
    enabled: true
    
    # AWS-specific: Parameter path prefix
    # parameterPath: /my-service/dev
    
    # GCP-specific: Store type (default: SecretManager)
    # store: SecretManager
    
    # Azure-specific: App Configuration endpoint
    # appConfigEndpoint: https://my-app-config.azconfig.io

---
# SOPS Private Key Secret
# The controller needs this to decrypt SOPS-encrypted files
#
# IMPORTANT: In production, use Sealed Secrets, External Secrets Operator,
# or similar to manage this secret securely. Never commit private keys!

apiVersion: v1
kind: Secret
metadata:
  name: sops-private-key
  namespace: default  # Must match SecretManagerConfig namespace
type: Opaque
stringData:
  # GPG Private Key for SOPS decryption
  # Export your GPG private key:
  # gpg --armor --export-secret-keys YOUR_KEY_ID > private-key.asc
  private-key: |
    -----BEGIN PGP PRIVATE KEY BLOCK-----
    
    lQOYBF+XYZABCAD... (your actual GPG private key)
    
    -----END PGP PRIVATE KEY BLOCK-----

---
# Alternative: SOPS Private Key Secret with different field names
# The controller checks multiple field names: private-key, key, gpg-key

apiVersion: v1
kind: Secret
metadata:
  name: sops-gpg-key
  namespace: default
type: Opaque
stringData:
  # Alternative field name - controller will find this too
  gpg-key: |
    -----BEGIN PGP PRIVATE KEY BLOCK-----
    
    lQOYBF+XYZABCAD... (your actual GPG private key)
    
    -----END PGP PRIVATE KEY BLOCK-----

