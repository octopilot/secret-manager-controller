---
# SecretManagerConfig for IDAM Service - Development Environment (ArgoCD)
#
# This example shows how to configure the controller for ArgoCD users.
# The controller references an ArgoCD Application resource instead of FluxCD GitRepository.
#
# Prerequisites:
# 1. An ArgoCD Application resource named "myapp-app" in the "argocd" namespace
# 2. The Application should reference a Git repository
# 3. GCP project with Secret Manager API enabled
# 4. Service account with Secret Manager Admin role
# 5. kustomize binary must be available in the controller container
#
# Note: The controller fully supports ArgoCD Applications by cloning the Git repository
# directly. The controller extracts Git source information from the Application spec
# and clones the repository automatically. Git authentication is supported via:
# - SSH keys: Mount SSH keys as a Kubernetes secret and configure GIT_SSH_COMMAND
# - HTTPS tokens: Use GIT_CREDENTIALS environment variable or credential helper
# - Public repositories: No authentication required
#
# Directory structure expected:
# microservices/myapp/deployment-configuration/profiles/dev/
#   ├── kustomization.yaml      # Contains secretGenerator configuration
#   ├── application.properties
#   └── application.secrets.env  # SOPS-encrypted secrets

apiVersion: secret-management.octopilot.io/v1beta1
kind: SecretManagerConfig
metadata:
  name: myapp-dev-secrets-argocd
  namespace: mysystem
spec:
  # Source reference - ArgoCD Application
  sourceRef:
    kind: Application  # ArgoCD Application
    name: myapp-app
    namespace: argocd
  
  # GCP project ID where secrets will be stored
  gcpProjectId: mysystem-dev
  
  # Environment/profile name to sync (must match directory name under profiles/)
  environment: dev
  
  # Kustomize path - path to kustomization.yaml (relative to Git repository root)
  # Controller will run `kustomize build` on this path and extract secrets
  kustomizePath: microservices/myapp/deployment-configuration/profiles/dev
  
  # Secret name prefix for GCP Secret Manager
  secretPrefix: myapp-dev

