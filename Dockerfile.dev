# Development Dockerfile for Secret Manager Controller (Tilt)
# Binary is cross-compiled on host (Apple Silicon -> x86_64 Linux) and copied in
# This matches PriceWhisperer's pattern

ARG TARGETPLATFORM=linux/amd64
FROM --platform=${TARGETPLATFORM} debian:bookworm-slim

# Install runtime dependencies
# git: Required for ArgoCD support (cloning repositories)
# kustomize: Required for Kustomize Build Mode
RUN apt-get update && apt-get install -y \
    ca-certificates \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/* && \
    # Install kustomize
    KUSTOMIZE_VERSION=5.8.0 && \
    curl -L "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv${KUSTOMIZE_VERSION}/kustomize_v${KUSTOMIZE_VERSION}_linux_amd64.tar.gz" | \
    tar -xz -C /usr/local/bin && \
    chmod +x /usr/local/bin/kustomize

# Create app directory with proper permissions for live updates
WORKDIR /app

# Copy pre-built binaries from build_artifacts (x86_64 Linux musl target)
# Note: Binary must exist before Docker build (ensured by Tilt resource_deps)
COPY ./build_artifacts/secret-manager-controller /app/secret-manager-controller
COPY ./build_artifacts/crdgen /usr/local/bin/crdgen
RUN chmod +x /app/secret-manager-controller /usr/local/bin/crdgen

# Create directories with write permissions for live updates
RUN chmod -R 777 /app

# Expose metrics port
EXPOSE 5000

# Set runtime environment
ENV RUST_BACKTRACE=1
ENV RUST_LOG=info

# Run the controller
ENTRYPOINT ["/app/secret-manager-controller"]

