# Base image for Secret Manager Controller
# Contains all runtime dependencies: git, curl, gnupg, kustomize, sops
# This base image is built once and published to ghcr.io/microscaler/secret-manager-controller-base-image
# The controller Dockerfiles then just copy the binary onto this base image

ARG TARGETPLATFORM=linux/amd64
ARG TARGETARCH
FROM debian:bookworm-slim

# Re-declare TARGETARCH after FROM (ARGs are scoped)
ARG TARGETARCH

# Version declarations
ARG KUSTOMIZE_VERSION=5.8.0
ARG SOPS_VERSION=3.8.1

# Install runtime dependencies
# git: Required for ArgoCD support (cloning repositories)
# curl: Required for downloading kustomize and sops
# gnupg: Required for GPG key handling in SOPS decryption
# ca-certificates: Required for HTTPS connections
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    ca-certificates \
    git \
    curl \
    gnupg \
    && rm -rf /var/lib/apt/lists/*

# Install kustomize
RUN set -eux; \
    case "${TARGETARCH}" in \
        amd64) ARCH="amd64" ;; \
        arm64) ARCH="arm64" ;; \
        *) echo "Unsupported architecture: ${TARGETARCH}" && exit 1 ;; \
    esac; \
    echo "Installing kustomize for architecture: ${ARCH} (TARGETARCH=${TARGETARCH})"; \
    curl -Lf "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/v${KUSTOMIZE_VERSION}/kustomize_v${KUSTOMIZE_VERSION}_linux_${ARCH}.tar.gz" -o /tmp/kustomize.tar.gz; \
    tar -xz -f /tmp/kustomize.tar.gz -C /usr/local/bin; \
    rm /tmp/kustomize.tar.gz; \
    chmod +x /usr/local/bin/kustomize

# Install sops
RUN set -eux; \
    case "${TARGETARCH}" in \
        amd64) ARCH="amd64" ;; \
        arm64) ARCH="arm64" ;; \
        *) echo "Unsupported architecture: ${TARGETARCH}" && exit 1 ;; \
    esac; \
    echo "Installing sops for architecture: ${ARCH} (TARGETARCH=${TARGETARCH})"; \
    curl -Lf "https://github.com/mozilla/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.${ARCH}" -o /usr/local/bin/sops; \
    chmod +x /usr/local/bin/sops

# Verify installations
RUN kustomize version && \
    sops --version

# Create app directory with proper permissions
WORKDIR /app
RUN chmod -R 777 /app

# Expose metrics port
EXPOSE 5000

# Set runtime environment
ENV RUST_BACKTRACE=1
ENV RUST_LOG=info
