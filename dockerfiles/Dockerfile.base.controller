# Base image for Secret Manager Controller
# Contains all runtime dependencies: git, curl, gnupg, kustomize, sops
# This base image is built once and published to gchr.io/microscaler/secret-manager-controller-base-image
# The controller Dockerfiles then just copy the binary onto this base image

ARG TARGETPLATFORM=linux/amd64
FROM debian:bookworm-slim

# Version declarations
ARG KUSTOMIZE_VERSION=5.8.0
ARG SOPS_VERSION=3.8.1

# Install runtime dependencies
# git: Required for ArgoCD support (cloning repositories)
# curl: Required for downloading kustomize and sops
# gnupg: Required for GPG key handling in SOPS decryption
# ca-certificates: Required for HTTPS connections
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    ca-certificates \
    git \
    curl \
    gnupg \
    && rm -rf /var/lib/apt/lists/*

    # Install kustomize
RUN curl -Lf "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/v${KUSTOMIZE_VERSION}/kustomize_v${KUSTOMIZE_VERSION}_linux_amd64.tar.gz" -o /tmp/kustomize.tar.gz && \
    tar -xz -f /tmp/kustomize.tar.gz -C /usr/local/bin && \
    rm /tmp/kustomize.tar.gz && \
    chmod +x /usr/local/bin/kustomize
    # Install sops
RUN curl -Lf "https://github.com/mozilla/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.amd64" -o /usr/local/bin/sops && \
    chmod +x /usr/local/bin/sops && \
    # Verify installations
    kustomize version && \
    sops --version

# Create app directory with proper permissions
WORKDIR /app
RUN chmod -R 777 /app

# Expose metrics port
EXPOSE 5000

# Set runtime environment
ENV RUST_BACKTRACE=1
ENV RUST_LOG=info


