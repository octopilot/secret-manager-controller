# Development Dockerfile for Secret Manager Controller (Tilt)
# Binary is cross-compiled on host (Apple Silicon -> x86_64 Linux) and copied in
# This matches PriceWhisperer's pattern
# Uses pre-built base image with all dependencies to avoid GPG issues and speed up builds

ARG TARGETPLATFORM=linux/amd64
FROM docker.io/microscaler/secret-manager-controller-base-image:latest

# Base image already has:
# - git, curl, gnupg, ca-certificates
# - kustomize (v5.8.0)
# - sops (v3.8.1)
# - /app directory with proper permissions
# - Environment variables (RUST_BACKTRACE, RUST_LOG)

# WORKDIR is already set to /app in base image

# Copy pre-built binaries from build_artifacts (x86_64 Linux musl target)
# Note: Binary must exist before Docker build (ensured by Tilt resource_deps)
COPY ./build_artifacts/secret-manager-controller /app/secret-manager-controller
COPY ./build_artifacts/crdgen /usr/local/bin/crdgen
# Make binaries executable
# Verify files exist and set permissions (fail fast if files are missing)
RUN test -f /app/secret-manager-controller && \
    test -f /usr/local/bin/crdgen && \
    chmod +x /app/secret-manager-controller /usr/local/bin/crdgen

# Create directories with write permissions for live updates
RUN chmod -R 777 /app

# Expose metrics port
EXPOSE 5000

# Set runtime environment
ENV RUST_BACKTRACE=1
ENV RUST_LOG=info

# Run the controller
ENTRYPOINT ["/app/secret-manager-controller"]

