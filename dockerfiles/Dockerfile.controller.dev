# Development Dockerfile for Secret Manager Controller (Tilt)
# Binary is cross-compiled on host (Apple Silicon -> x86_64 Linux) and copied in
# Standard development Dockerfile pattern
# Uses pre-built base image with all dependencies to avoid GPG issues and speed up builds
# Pass build-arg REGISTRY_ORG (default: octopilot) to pull base image from ghcr.io.

ARG REGISTRY_ORG=octopilot
ARG TARGETPLATFORM=linux/amd64
FROM ghcr.io/${REGISTRY_ORG}/secret-manager-controller-base-image:latest

# Base image already has:
# - git, curl, gnupg, ca-certificates
# - kustomize (v5.8.0)
# - sops (v3.8.1)
# - /app directory with proper permissions
# - Environment variables (RUST_BACKTRACE, RUST_LOG)

# WORKDIR is already set to /app in base image
# Create /tmp/smc directory structure for artifact cache (volume will mount here)
# /app is already writable (777) from base image for live_update sync
RUN mkdir -p /tmp/smc && \
    chmod -R 777 /tmp/smc
# Copy pre-built binary from target directory (x86_64 Linux musl target)
# Note: Binary must exist before Docker build (ensured by Tilt deps)
# Copy from target directory directly
# Volume mount at /tmp/smc won't interfere with /app/
# crdgen is run on the host, not in the container
COPY ./target/x86_64-unknown-linux-musl/debug/secret-manager-controller /app/secret-manager-controller
# Make binary executable
# Verify file exists and set permissions (fail fast if file is missing)
RUN test -f /app/secret-manager-controller && \
    chmod +x /app/secret-manager-controller



# Expose metrics port
EXPOSE 5000

# Set runtime environment
ENV RUST_BACKTRACE=1
ENV RUST_LOG=info

# Run the controller
ENTRYPOINT ["/app/secret-manager-controller"]

