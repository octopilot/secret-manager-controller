apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: secret-manager-controller
rules:
# Watch SecretManagerConfig resources in all namespaces
- apiGroups:
  - secret-management.octopilot.io
  resources:
  - secretmanagerconfigs
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - secret-management.octopilot.io
  resources:
  - secretmanagerconfigs/status
  verbs:
  - update
  - patch
# Watch and patch FluxCD GitRepository resources
# Patch permission is needed to suspend/resume Git pulls via suspendGitPulls field
# Status access is needed to read artifact URLs from GitRepository status
- apiGroups:
  - source.toolkit.fluxcd.io
  resources:
  - gitrepositories
  verbs:
  - get
  - list
  - watch
  - patch
- apiGroups:
  - source.toolkit.fluxcd.io
  resources:
  - gitrepositories/status
  verbs:
  - get
# Watch ArgoCD Application resources
- apiGroups:
  - argoproj.io
  resources:
  - applications
  verbs:
  - get
  - list
  - watch
# Access SOPS private key secrets across all namespaces
# The controller watches for SOPS secrets in all namespaces (tilt, dev, stage, prod, etc.)
# to detect changes and hot-reload the key without restarting
# Note: Kubernetes watch API requires get permission on resources being watched
# The controller filters to specific secret names in code, so this is safe
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - get
  - list
  - watch
# Watch ConfigMap for controller configuration hot-reload
# The controller watches its own ConfigMap to reload configuration without restart
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - get
  - list
  - watch
  resourceNames:
  - secret-manager-controller-config

