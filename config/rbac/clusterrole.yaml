apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: secret-manager-controller
rules:
# Watch SecretManagerConfig resources in all namespaces
- apiGroups:
  - secret-management.microscaler.io
  resources:
  - secretmanagerconfigs
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - secret-management.microscaler.io
  resources:
  - secretmanagerconfigs/status
  verbs:
  - update
  - patch
# Watch and patch FluxCD GitRepository resources
# Patch permission is needed to suspend/resume Git pulls via suspendGitPulls field
# Status access is needed to read artifact URLs from GitRepository status
- apiGroups:
  - source.toolkit.fluxcd.io
  resources:
  - gitrepositories
  verbs:
  - get
  - list
  - watch
  - patch
- apiGroups:
  - source.toolkit.fluxcd.io
  resources:
  - gitrepositories/status
  verbs:
  - get
# Watch ArgoCD Application resources
- apiGroups:
  - argoproj.io
  resources:
  - applications
  verbs:
  - get
  - list
  - watch
# Access SOPS private key secrets across all namespaces
# The controller watches for SOPS secrets in all namespaces (tilt, dev, stage, prod, etc.)
# to detect changes and hot-reload the key without restarting
# Note: list/watch must be on all secrets (watcher needs to list first), but controller filters to specific names
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - list
  - watch
# Allow get on specific secret names in all namespaces
# This allows the controller to load SOPS keys from any namespace where they exist
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - get
  resourceNames:
  - sops-private-key
  - sops-gpg-key
  - gpg-key

