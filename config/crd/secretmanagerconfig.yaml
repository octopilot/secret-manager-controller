# This file is auto-generated by crdgen
# DO NOT EDIT THIS FILE MANUALLY
# If there are malformed YAML issues, fix them in the Rust code (src/crd/mod.rs)
# This file will be overwritten on every code update
#
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: secretmanagerconfigs.secret-management.octopilot.io
spec:
  group: secret-management.octopilot.io
  names:
    categories: []
    kind: SecretManagerConfig
    plural: secretmanagerconfigs
    shortNames:
    - smc
    singular: secretmanagerconfig
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .status.description
      name: Description
      type: string
    - jsonPath: .status.conditions[?(@.type=="Ready")].status
      name: Ready
      type: string
    name: v1beta1
    schema:
      openAPIV3Schema:
        description: Auto-generated derived type for SecretManagerConfigSpec via `CustomResource`
        properties:
          spec:
            description: |-
              SecretManagerConfig Custom Resource Definition

              This CRD defines the configuration for syncing secrets from GitOps repositories
              to cloud secret managers (GCP, AWS, Azure).

              # Example

              ```yaml
              apiVersion: secret-management.octopilot.io/v1beta1
              kind: SecretManagerConfig
              metadata:
                name: my-service-secrets
                namespace: default
              spec:
                sourceRef:
                  kind: GitRepository
                  name: my-repo
                  namespace: octopilot-system
                provider:
                  gcp:
                    projectId: my-gcp-project
                secrets:
                  environment: dev
                  kustomizePath: microservices/my-service/deployment-configuration/profiles/dev
              ```
            properties:
              configs:
                description: |-
                  Config store configuration for routing application.properties to config stores
                  When enabled, properties are stored individually in config stores instead of as a JSON blob in secret stores
                nullable: true
                properties:
                  appConfigEndpoint:
                    description: |-
                      Azure-specific: App Configuration endpoint
                      Only applies when provider.type == azure
                      Optional: defaults to auto-detection from vault region if not specified
                      Example: https://my-app-config.azconfig.io
                    nullable: true
                    type: string
                  enabled:
                    default: false
                    description: |-
                      Enable config store sync (default: false for backward compatibility)
                      When true, application.properties files are routed to config stores
                      When false, properties are stored as a JSON blob in secret stores (current behavior)
                    type: boolean
                  parameterPath:
                    description: |-
                      AWS-specific: Parameter path prefix
                      Only applies when provider.type == aws
                      Optional: defaults to /{prefix}/{environment} if not specified
                      Example: /my-service/dev
                    nullable: true
                    type: string
                  store:
                    description: |-
                      GCP-specific: Store type (default: SecretManager)
                      Only applies when provider.type == gcp
                      - SecretManager: Store configs as individual secrets in Secret Manager (interim solution)
                      - ParameterManager: Store configs in Parameter Manager (future, after ESO contribution)
                    enum:
                    - secretManager
                    - ParameterManager
                    - null
                    nullable: true
                    type: string
                type: object
              diffDiscovery:
                default: true
                description: |-
                  Enable diff discovery
                  When enabled, detects if secrets have been tampered with in Secret Manager or Parameter Manager
                  and logs warnings when differences are found between Git (source of truth) and cloud provider
                  Default: true (enabled)
                type: boolean
              gitRepositoryPullInterval:
                default: 5m
                description: |-
                  GitRepository pull update interval
                  How often to check for updates from the GitRepository source
                  Format: Kubernetes duration string (e.g., "1m", "5m", "1h")
                  Minimum: 1m (60 seconds) - shorter intervals may hit API rate limits
                  Default: "5m" (5 minutes)
                  Recommended: 5m or greater to avoid rate limiting
                type: string
              hotReload:
                description: |-
                  Hot reload configuration for controller-level settings
                  Controls whether the controller watches for ConfigMap changes and hot-reloads configuration
                  When enabled, watches the specified ConfigMap and reloads configuration without pod restart
                  Environment variables are populated from the ConfigMap using `envFrom` in the deployment
                  Default: disabled (false) - most users rely on pod restarts via Reloader or manual updates
                nullable: true
                properties:
                  configMapName:
                    default: secret-manager-controller-config
                    description: |-
                      ConfigMap name to watch for configuration changes
                      The ConfigMap should be in the same namespace as the controller
                      Environment variables are populated from this ConfigMap using `envFrom` in the deployment
                      Default: "secret-manager-controller-config"
                    type: string
                  configMapNamespace:
                    description: |-
                      ConfigMap namespace
                      Namespace where the ConfigMap is located
                      If not specified, uses the controller's namespace (from POD_NAMESPACE env var)
                    nullable: true
                    type: string
                  enabled:
                    default: false
                    description: |-
                      Enable hot-reload of controller configuration
                      When true, watches ConfigMap for changes and reloads configuration without restart
                      When false, configuration is only loaded at startup
                      Default: false (disabled) - most users rely on pod restarts via Reloader or manual updates
                    type: boolean
                type: object
              logging:
                description: |-
                  Logging configuration for fine-grained control over log verbosity
                  Allows setting different log levels for different operations (secrets, properties, reconciliation, etc.)
                  Default: INFO for most operations, WARN for diff discovery, DEBUG for SOPS and provider operations
                nullable: true
                properties:
                  diffDiscovery:
                    default: WARN
                    description: |-
                      Log level for diff discovery operations (comparing Git vs cloud provider)
                      Default: WARN (only log when differences are found)
                    enum:
                    - ERROR
                    - WARN
                    - INFO
                    - DEBUG
                    type: string
                  git:
                    default: INFO
                    description: |-
                      Log level for Git/artifact operations (clone, pull, resolve)
                      Default: INFO
                    enum:
                    - ERROR
                    - WARN
                    - INFO
                    - DEBUG
                    type: string
                  kustomize:
                    default: INFO
                    description: |-
                      Log level for Kustomize operations
                      Default: INFO
                    enum:
                    - ERROR
                    - WARN
                    - INFO
                    - DEBUG
                    type: string
                  properties:
                    default: INFO
                    description: |-
                      Log level for property/config operations (create, update, delete)
                      Default: INFO
                    enum:
                    - ERROR
                    - WARN
                    - INFO
                    - DEBUG
                    type: string
                  provider:
                    default: DEBUG
                    description: |-
                      Log level for provider operations (authentication, API calls)
                      Default: DEBUG (detailed API interactions)
                    enum:
                    - ERROR
                    - WARN
                    - INFO
                    - DEBUG
                    type: string
                  reconciliation:
                    default: INFO
                    description: |-
                      Log level for reconciliation operations (start, complete, errors)
                      Default: INFO
                    enum:
                    - ERROR
                    - WARN
                    - INFO
                    - DEBUG
                    type: string
                  secrets:
                    default: INFO
                    description: |-
                      Log level for secret operations (create, update, delete, enable, disable)
                      Default: INFO
                    enum:
                    - ERROR
                    - WARN
                    - INFO
                    - DEBUG
                    type: string
                  sops:
                    default: DEBUG
                    description: |-
                      Log level for SOPS decryption operations
                      Default: DEBUG (detailed decryption process)
                    enum:
                    - ERROR
                    - WARN
                    - INFO
                    - DEBUG
                    type: string
                type: object
              notifications:
                description: |-
                  Notification configuration for drift detection alerts
                  Supports both FluxCD (via Provider reference) and ArgoCD (via Application annotations)
                  When drift is detected, notifications are sent according to this configuration
                nullable: true
                properties:
                  argocd:
                    description: ArgoCD notification configuration (for Application sources). Optional. When set, adds annotations to the ArgoCD Application resource to trigger notifications when drift is detected.
                    nullable: true
                    properties:
                      subscriptions:
                        description: List of notification subscriptions
                        items:
                          properties:
                            channel:
                              description: Notification channel (e.g., '#secrets-alerts' for Slack, 'team@example.com' for email)
                              type: string
                            service:
                              description: Notification service (e.g., 'slack', 'email', 'webhook')
                              type: string
                            trigger:
                              description: Notification trigger name (e.g., 'drift-detected')
                              type: string
                          required:
                          - channel
                          - service
                          - trigger
                          type: object
                        type: array
                    required:
                    - subscriptions
                    type: object
                  fluxcd:
                    description: FluxCD notification configuration (for GitRepository sources). Optional. When set, creates a FluxCD Alert CRD that watches this SecretManagerConfig and sends notifications via the specified Provider when drift is detected.
                    nullable: true
                    properties:
                      providerRef:
                        description: FluxCD Provider reference
                        properties:
                          name:
                            description: Name of the FluxCD Provider resource
                            type: string
                          namespace:
                            description: Namespace of the FluxCD Provider resource. Optional. Defaults to the same namespace as the SecretManagerConfig.
                            nullable: true
                            type: string
                        required:
                        - name
                        type: object
                    required:
                    - providerRef
                    type: object
                type: object
              otel:
                description: |-
                  OpenTelemetry configuration for distributed tracing (optional)
                  Supports OTLP exporter (to OpenTelemetry Collector) and Datadog direct export
                  If not specified, OpenTelemetry is disabled and standard tracing is used
                nullable: true
                properties:
                  apiKey:
                    description: Datadog API key - used when type is 'datadog'
                    type: string
                  endpoint:
                    description: OTLP endpoint URL (e.g., "http://otel-collector:4317") - required when type is 'otlp'
                    type: string
                  environment:
                    description: Deployment environment (e.g., "dev", "prod")
                    type: string
                  serviceName:
                    description: Service name for traces (defaults to "secret-manager-controller")
                    type: string
                  serviceVersion:
                    description: Service version for traces (defaults to Cargo package version)
                    type: string
                  site:
                    description: Datadog site (e.g., "datadoghq.com", "us3.datadoghq.com") - used when type is 'datadog'
                    type: string
                  type:
                    description: 'OpenTelemetry exporter type: ''otlp'' for OTLP exporter, ''datadog'' for Datadog direct export'
                    enum:
                    - otlp
                    - datadog
                    type: string
                required:
                - type
                type: object
              provider:
                description: Cloud provider configuration - supports GCP, AWS, and Azure
                oneOf:
                - required:
                  - gcp
                - required:
                  - aws
                - required:
                  - azure
                properties:
                  aws:
                    description: AWS configuration for Secrets Manager
                    properties:
                      auth:
                        description: AWS authentication configuration. If not specified, defaults to IRSA (IAM Roles for Service Accounts) - recommended.
                        nullable: true
                        properties:
                          authType:
                            description: 'Authentication type: ''irsa'' for IAM Roles for Service Accounts'
                            enum:
                            - irsa
                            type: string
                          roleArn:
                            description: 'AWS IAM role ARN to assume. Format: arn:aws:iam::<account-id>:role/<role-name>'
                            type: string
                        required:
                        - authType
                        - roleArn
                        type: object
                      region:
                        description: |-
                          AWS region for Secrets Manager (e.g., "us-east-1", "eu-west-1", "us-gov-west-1", "cn-north-1")
                          Format: [a-z]{2}-[a-z]+-[0-9]+ (standard) or [a-z]{2}-gov-[a-z]+-[0-9]+ (gov) or cn-[a-z]+-[0-9]+ (China)
                          See: https://docs.aws.amazon.com/general/latest/gr/rande.html
                        pattern: ^[a-z]{2}-[a-z]+-[0-9]+$|^[a-z]{2}-gov-[a-z]+-[0-9]+$|^[a-z]{2}-iso-[a-z]+-[0-9]+$|^cn-[a-z]+-[0-9]+$|^local$
                        type: string
                    required:
                    - region
                    type: object
                  azure:
                    description: Azure configuration for Key Vault
                    properties:
                      auth:
                        description: Azure authentication configuration. If not specified, defaults to Workload Identity (recommended).
                        nullable: true
                        properties:
                          authType:
                            description: 'Authentication type: ''workloadIdentity'' for Workload Identity'
                            enum:
                            - workloadIdentity
                            type: string
                          clientId:
                            description: Azure service principal client ID
                            type: string
                        required:
                        - authType
                        - clientId
                        type: object
                      location:
                        description: |-
                          Azure location/region for Key Vault (e.g., "eastus", "westus2", "southeastasia")
                          Required: Must be specified for all Azure configurations
                          Format: [direction][region][number] (e.g., eastus, westus2)
                          See: https://azure.microsoft.com/en-us/explore/global-infrastructure/geographies/
                        pattern: ^[a-z]+[0-9]*$
                        type: string
                      vaultName:
                        description: Azure Key Vault name
                        type: string
                    required:
                    - location
                    - vaultName
                    type: object
                  gcp:
                    description: GCP configuration for Secret Manager
                    properties:
                      auth:
                        description: GCP authentication configuration. If not specified, defaults to Workload Identity (recommended).
                        nullable: true
                        properties:
                          authType:
                            description: 'Authentication type: ''workloadIdentity'' for Workload Identity'
                            enum:
                            - workloadIdentity
                            type: string
                          serviceAccountEmail:
                            description: 'GCP service account email to impersonate. Format: <service-account-name>@<project-id>.iam.gserviceaccount.com'
                            type: string
                        required:
                        - authType
                        - serviceAccountEmail
                        type: object
                      location:
                        description: |-
                          GCP location/region for Secret Manager (e.g., "us-central1", "europe-west1")
                          Required: Must be specified for all GCP configurations
                          Format: [continent]-[direction][number] (e.g., us-central1, europe-west1)
                          See: https://cloud.google.com/about/locations
                        pattern: ^[a-z]+-[a-z]+[0-9]+$
                        type: string
                      projectId:
                        description: GCP project ID for Secret Manager
                        type: string
                    required:
                    - location
                    - projectId
                    type: object
                  type:
                    description: Provider type (optional, ignored during deserialization - use gcp/aws/azure fields instead)
                    enum:
                    - gcp
                    - aws
                    - azure
                    type: string
                type: object
              reconcileInterval:
                default: 1m
                description: |-
                  Reconcile interval
                  How often to reconcile secrets between Git and cloud providers (Secret Manager or Parameter Manager)
                  Format: Kubernetes duration string (e.g., "1m", "30s", "5m")
                  Default: "1m" (1 minute)
                type: string
              secrets:
                description: Secrets sync configuration
                properties:
                  basePath:
                    description: |-
                      Base path for application files (optional, used only if kustomize_path is not specified)
                      If not specified, searches from repository root
                      Examples: "microservices", "services", "apps", or "." for root
                    nullable: true
                    type: string
                  environment:
                    description: |-
                      Environment/profile name to sync (e.g., "dev", "dev-cf", "prod-cf", "pp-cf")
                      This must match the directory name under profiles/
                    type: string
                  kustomizePath:
                    description: |-
                      Kustomize path - path to kustomization.yaml file (relative to GitRepository root)
                      If specified, controller will run `kustomize build` on this path and extract secrets
                      from the generated Kubernetes Secret resources. This supports kustomize overlays,
                      patches, and generators. Works with any GitOps tool (FluxCD, ArgoCD, etc.)
                      Examples: "microservices/idam/deployment-configuration/profiles/dev" or "./deployment-configuration/profiles/dev"
                      If not specified, controller reads raw application.secrets.env files directly
                    nullable: true
                    type: string
                  prefix:
                    description: |-
                      Secret name prefix (default: repository name)
                      Matches kustomize-google-secret-manager prefix behavior
                    nullable: true
                    type: string
                  suffix:
                    description: |-
                      Secret name suffix (optional)
                      Matches kustomize-google-secret-manager suffix behavior
                      Common use cases: environment identifiers, tags, etc.
                    nullable: true
                    type: string
                required:
                - environment
                type: object
              sourceRef:
                description: |-
                  Source reference - supports FluxCD GitRepository and ArgoCD Application
                  This makes the controller GitOps-agnostic
                properties:
                  gitCredentials:
                    description: |-
                      Git credentials reference for ArgoCD Application cloning (optional)
                      When using ArgoCD Application as source, this allows specifying a Kubernetes secret
                      containing git credentials for private repositories. If not specified, the controller
                      will attempt to clone without credentials (works for public repos).

                      The secret should contain either:
                      - For HTTPS: `username` and `password` keys (or `token` as password)
                      - For SSH: `identity` key containing the SSH private key

                      Example:
                      ```yaml
                      gitCredentials:
                        name: git-credentials
                        namespace: my-namespace
                      ```
                    nullable: true
                    properties:
                      name:
                        description: Secret name containing git credentials
                        type: string
                      namespace:
                        description: Secret namespace (defaults to sourceRef.namespace if not specified)
                        nullable: true
                        type: string
                    required:
                    - name
                    type: object
                  kind:
                    default: GitRepository
                    description: 'Source kind: "GitRepository" (FluxCD) or "Application" (ArgoCD)'
                    type: string
                  name:
                    description: Source name
                    type: string
                  namespace:
                    description: Source namespace
                    type: string
                required:
                - name
                - namespace
                type: object
              suspend:
                default: false
                description: |-
                  Suspend reconciliation
                  When true, the controller will skip reconciliation for this resource
                  Useful for troubleshooting or during intricate CI/CD transitions where secrets need to be carefully managed
                  Manual reconciliation via msmctl will also be blocked when suspended
                  Default: false (reconciliation enabled)
                type: boolean
              suspendGitPulls:
                default: false
                description: |-
                  Suspend GitRepository pulls
                  When true, suspends Git pulls from the referenced GitRepository but continues reconciliation with the last pulled commit
                  This is useful when you want to freeze the Git state but keep syncing secrets from the current commit
                  The controller will automatically patch the GitRepository resource to set suspend: true/false
                  Default: false (Git pulls enabled)
                type: boolean
              triggerUpdate:
                default: true
                description: |-
                  Enable update triggers
                  When enabled, automatically updates cloud provider secrets if Git values have changed since last pull
                  This ensures Git remains the source of truth
                  Default: true (enabled)
                type: boolean
            required:
            - provider
            - secrets
            - sourceRef
            type: object
          status:
            description: |-
              Status of the SecretManagerConfig resource

              Tracks reconciliation state, errors, and metrics.
            nullable: true
            properties:
              conditions:
                default: []
                description: Conditions represent the latest available observations
                items:
                  description: Condition represents a condition of a resource
                  properties:
                    lastTransitionTime:
                      description: Last transition time
                      nullable: true
                      type: string
                    message:
                      description: Message describing the condition
                      nullable: true
                      type: string
                    reason:
                      description: Reason for the condition
                      nullable: true
                      type: string
                    status:
                      description: Status of the condition (True, False, Unknown)
                      type: string
                    type:
                      description: Type of condition
                      type: string
                  required:
                  - status
                  - type
                  type: object
                type: array
              decryptionStatus:
                description: |-
                  SOPS decryption status
                  Values: Success, TransientFailure, PermanentFailure, NotApplicable
                  NotApplicable means no SOPS-encrypted files were processed
                nullable: true
                type: string
              description:
                description: |-
                  Human-readable description of current state
                  Examples: "Clone failed, repo unavailable", "Reconciling secrets to Secret Manager", "Reconciling properties to Parameter Manager"
                nullable: true
                type: string
              lastDecryptionAttempt:
                description: |-
                  Timestamp of last SOPS decryption attempt (RFC3339)
                  Updated whenever a SOPS-encrypted file is processed
                nullable: true
                type: string
              lastDecryptionError:
                description: |-
                  Last SOPS decryption error message (if any)
                  Only set when decryption fails
                nullable: true
                type: string
              lastReconcileTime:
                description: Last reconciliation time
                nullable: true
                type: string
              nextReconcileTime:
                description: |-
                  Next scheduled reconciliation time (RFC3339)
                  Used to persist periodic reconciliation schedule across watch restarts
                nullable: true
                type: string
              observedGeneration:
                description: Observed generation
                format: int64
                nullable: true
                type: integer
              phase:
                description: |-
                  Current phase of reconciliation
                  Values: Pending, Started, Cloning, Updating, Failed, Ready
                nullable: true
                type: string
              secretsSynced:
                description: Number of secrets synced
                format: int32
                nullable: true
                type: integer
              sopsKeyAvailable:
                description: |-
                  Whether SOPS private key is available in the resource namespace
                  Updated when key secret changes (via watch)
                  Used to avoid redundant API calls on every reconcile
                nullable: true
                type: boolean
              sopsKeyLastChecked:
                description: Last time the SOPS key availability was checked (RFC3339)
                nullable: true
                type: string
              sopsKeyNamespace:
                description: |-
                  Namespace where the SOPS key was found
                  Usually the resource namespace, but could be controller namespace if fallback
                nullable: true
                type: string
              sopsKeySecretName:
                description: |-
                  Name of the SOPS key secret found in the resource namespace
                  Example: "sops-private-key"
                nullable: true
                type: string
              sync:
                description: |-
                  Sync state tracking for secrets and properties
                  Tracks which resources have been successfully pushed and how many times updated
                nullable: true
                properties:
                  properties:
                    additionalProperties:
                      description: State tracking for a synced resource (secret or property)
                      properties:
                        exists:
                          description: |-
                            Whether the resource exists in the remote store
                            true = resource has been successfully pushed at least once
                            false = resource has never been pushed (or was deleted externally)
                          type: boolean
                        updateCount:
                          default: 0
                          description: |-
                            Number of times the resource value has been updated since the CR was created
                            This only increments when the value actually changes (not on every check)
                            0 = resource exists but has never been updated (only created once)
                            >0 = resource has been updated this many times due to value changes in Git
                          format: int32
                          type: integer
                      required:
                      - exists
                      type: object
                    description: |-
                      Track which properties have been successfully pushed to the config store
                      Maps property name to sync state information
                    nullable: true
                    type: object
                  secrets:
                    additionalProperties:
                      description: State tracking for a synced resource (secret or property)
                      properties:
                        exists:
                          description: |-
                            Whether the resource exists in the remote store
                            true = resource has been successfully pushed at least once
                            false = resource has never been pushed (or was deleted externally)
                          type: boolean
                        updateCount:
                          default: 0
                          description: |-
                            Number of times the resource value has been updated since the CR was created
                            This only increments when the value actually changes (not on every check)
                            0 = resource exists but has never been updated (only created once)
                            >0 = resource has been updated this many times due to value changes in Git
                          format: int32
                          type: integer
                      required:
                      - exists
                      type: object
                    description: |-
                      Track which secrets have been successfully pushed to the cloud provider
                      Maps secret name to sync state information
                    nullable: true
                    type: object
                type: object
            type: object
        required:
        - spec
        title: SecretManagerConfig
        type: object
    served: true
    storage: true
    subresources:
      status: {}
