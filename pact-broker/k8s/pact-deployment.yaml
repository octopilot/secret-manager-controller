---
# Combined Pact Infrastructure Deployment
# Optimized deployment combining all Pact-related containers into a single pod
# This reduces startup time and simplifies orchestration
#
# Contains:
# - pact-broker: Main Pact Broker service (port 9292)
# - mock-webhook: Webhook receiver for testing (port 1237)
# - aws-mock-server: AWS Secrets Manager mock (port 1234)
# - gcp-mock-server: GCP Secret Manager mock (port 1235)
# - azure-mock-server: Azure Key Vault mock (port 1236)
# - manager: Management sidecar that watches broker and publishes contracts
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pact-infrastructure
  namespace: secret-manager-controller-pact-broker
  labels:
    app: pact-infrastructure
    app.kubernetes.io/component: pact-infrastructure
    app.kubernetes.io/part-of: secret-manager-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pact-infrastructure
  template:
    metadata:
      labels:
        app: pact-infrastructure
        app.kubernetes.io/component: pact-infrastructure
        app.kubernetes.io/part-of: secret-manager-controller
    spec:
      serviceAccountName: pact-manager
      initContainers:
      # Initialize Pact Broker database directory
      - name: init-pact-db
        image: busybox:latest
        command: ['sh', '-c', 'mkdir -p /pacts && chmod 777 /pacts']
        volumeMounts:
        - name: pacts-storage
          mountPath: /pacts
      containers:
      # Pact Broker - Main service
      - name: pact-broker
        image: pactfoundation/pact-broker:latest
        ports:
        - containerPort: 9292
          name: http
        env:
        - name: PACT_BROKER_PORT
          value: "9292"
        - name: PACT_BROKER_DATABASE_URL
          value: "sqlite:///pacts/pact_broker.sqlite"
        - name: PACT_BROKER_BASIC_AUTH_USERNAME
          value: "pact"
        - name: PACT_BROKER_BASIC_AUTH_PASSWORD
          value: "pact"
        - name: PACT_BROKER_PUBLIC_HEARTBEAT
          value: "true"
        - name: PACT_BROKER_ALLOW_PUBLIC_READ
          value: "true"
        - name: PACT_BROKER_LOG_LEVEL
          value: INFO
        - name: PACT_BROKER_WEBHOOK_HTTP_VERIFY
          value: "false"
        volumeMounts:
        - name: pacts-storage
          mountPath: /pacts
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 256Mi
            cpu: 200m
        startupProbe:
          httpGet:
            path: /diagnostic/status/heartbeat
            port: 9292
          initialDelaySeconds: 30
          periodSeconds: 15
          timeoutSeconds: 5
          failureThreshold: 5
        readinessProbe:
          httpGet:
            path: /diagnostic/status/heartbeat
            port: 9292
          initialDelaySeconds: 15
          periodSeconds: 30
          timeoutSeconds: 3
          failureThreshold: 3
        livenessProbe:
          httpGet:
            path: /diagnostic/status/heartbeat
            port: 9292
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 3
          failureThreshold: 3

      # Mock Webhook Server
      - name: mock-webhook
        image: mock-webhook
        imagePullPolicy: Always
        command: ["/app/webhook"]
        ports:
        - containerPort: 1237
          name: http
        env:
        - name: PORT
          value: "1237"
        resources:
          requests:
            memory: 64Mi
            cpu: 50m
          limits:
            memory: 128Mi
            cpu: 100m
        startupProbe:
          httpGet:
            path: /health
            port: 1237
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 2
          failureThreshold: 30  # Allow up to 5.5 minutes: 30s initial + (30 * 10s) = 330s
          # This accounts for: broker startup (~30-60s) + manager detection/publish (~10-30s) + webhook startup
        readinessProbe:
          httpGet:
            path: /health
            port: 1237
          initialDelaySeconds: 2
          periodSeconds: 30
          timeoutSeconds: 1
          failureThreshold: 3
        livenessProbe:
          httpGet:
            path: /health
            port: 1237
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 2
          failureThreshold: 3

      # AWS Mock Server
      - name: aws-mock-server
        image: pact-mock-server
        imagePullPolicy: Always
        command: ["/app/aws-mock-server"]
        ports:
        - containerPort: 1234
          name: http
        env:
        # Use localhost:9292 to reach pact-broker within the same pod
        # All containers share the network namespace, so traffic stays within the pod
        - name: PACT_BROKER_URL
          value: "http://localhost:9292"
        - name: PACT_BROKER_USERNAME
          value: "pact"
        - name: PACT_BROKER_PASSWORD
          value: "pact"
        - name: PACT_PROVIDER
          value: "AWS-Secrets-Manager"
        - name: PACT_CONSUMER
          value: "Secret-Manager-Controller"
        - name: PORT
          value: "1234"
        - name: MANAGER_URL
          value: "http://localhost:1238"
        - name: DATABASE_URL
          value: "postgresql://pact:pact@postgres.secret-manager-controller-pact-broker.svc.cluster.local:5432/pact_mock_servers"
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 256Mi
            cpu: 100m
        startupProbe:
          httpGet:
            path: /health
            port: 1234
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 15  # Allow up to 3.5 minutes: 60s initial + (15 * 10s) = 210s
          # This accounts for: broker startup (~30-60s) + manager detection/publish (~10-30s) + mock server wait_for_broker_and_pacts (up to 90s)
        readinessProbe:
          httpGet:
            path: /health
            port: 1234
          initialDelaySeconds: 2
          periodSeconds: 30
          timeoutSeconds: 3
          failureThreshold: 3
        livenessProbe:
          httpGet:
            path: /health
            port: 1234
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 3
          failureThreshold: 3

      # GCP Mock Server
      - name: gcp-mock-server
        image: pact-mock-server
        imagePullPolicy: Always
        command: ["/app/gcp-mock-server"]
        ports:
        - containerPort: 1235
          name: http
        env:
        # Use localhost:9292 to reach pact-broker within the same pod
        # All containers share the network namespace, so traffic stays within the pod
        - name: PACT_BROKER_URL
          value: "http://localhost:9292"
        - name: PACT_BROKER_USERNAME
          value: "pact"
        - name: PACT_BROKER_PASSWORD
          value: "pact"
        - name: PACT_PROVIDER
          value: "GCP-Secret-Manager"
        - name: PACT_CONSUMER
          value: "Secret-Manager-Controller"
        - name: PORT
          value: "1235"
        - name: MANAGER_URL
          value: "http://localhost:1238"
        - name: DATABASE_URL
          value: "postgresql://pact:pact@postgres.secret-manager-controller-pact-broker.svc.cluster.local:5432/pact_mock_servers"
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 256Mi
            cpu: 100m
        startupProbe:
          httpGet:
            path: /health
            port: 1235
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 15  # Allow up to 3.5 minutes: 60s initial + (15 * 10s) = 210s
          # This accounts for: broker startup (~30-60s) + manager detection/publish (~10-30s) + mock server wait_for_broker_and_pacts (up to 90s)
        readinessProbe:
          httpGet:
            path: /health
            port: 1235
          initialDelaySeconds: 2
          periodSeconds: 30
          timeoutSeconds: 3
          failureThreshold: 3
        livenessProbe:
          httpGet:
            path: /health
            port: 1235
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 3
          failureThreshold: 3

      # Azure Mock Server
      - name: azure-mock-server
        image: pact-mock-server
        imagePullPolicy: Always
        command: ["/app/azure-mock-server"]
        ports:
        - containerPort: 1236
          name: http
        env:
        # Use localhost:9292 to reach pact-broker within the same pod
        # All containers share the network namespace, so traffic stays within the pod
        - name: PACT_BROKER_URL
          value: "http://localhost:9292"
        - name: PACT_BROKER_USERNAME
          value: "pact"
        - name: PACT_BROKER_PASSWORD
          value: "pact"
        - name: PACT_PROVIDER
          value: "Azure-Key-Vault"
        - name: PACT_CONSUMER
          value: "Secret-Manager-Controller"
        - name: PORT
          value: "1236"
        - name: MANAGER_URL
          value: "http://localhost:1238"
        - name: DATABASE_URL
          value: "postgresql://pact:pact@postgres.secret-manager-controller-pact-broker.svc.cluster.local:5432/pact_mock_servers"
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 256Mi
            cpu: 100m
        startupProbe:
          httpGet:
            path: /health
            port: 1236
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 15  # Allow up to 3.5 minutes: 60s initial + (15 * 10s) = 210s
          # This accounts for: broker startup (~30-60s) + manager detection/publish (~10-30s) + mock server wait_for_broker_and_pacts (up to 90s)
        readinessProbe:
          httpGet:
            path: /health
            port: 1236
          initialDelaySeconds: 2
          periodSeconds: 30
          timeoutSeconds: 3
          failureThreshold: 3
        livenessProbe:
          httpGet:
            path: /health
            port: 1236
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 3
          failureThreshold: 3

      # Manager sidecar - manages Pact infrastructure lifecycle
      # Current responsibilities:
      # - Watches for Pact broker to start and port to be available
      # - Publishes Pact contracts to broker once ready
      # Future responsibilities can be added here (health monitoring, config updates, etc.)
      - name: manager
        image: pact-mock-server
        imagePullPolicy: Always
        command: ["/app/manager"]
        env:
        - name: BROKER_URL
          value: "http://localhost:9292"
        - name: BROKER_USERNAME
          value: "pact"
        - name: BROKER_PASSWORD
          value: "pact"
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: CONFIGMAP_NAME
          value: "pact-contracts"
        - name: CONFIGMAP_PATH
          value: "/pacts-configmap"
        - name: PUBLISHED_FLAG_PATH
          value: "/tmp/pacts-published.flag"
        - name: GIT_BRANCH
          value: "main"
        - name: GIT_COMMIT
          value: "dev"
        - name: BROKER_PORT
          value: "9292"
        - name: BROKER_HEALTH_PATH
          value: "/diagnostic/status/heartbeat"
        - name: CHECK_INTERVAL_SECS
          value: "2"
        - name: BROKER_TIMEOUT_SECS
          value: "90"
        - name: HEALTH_PORT
          value: "1238"
        ports:
        - containerPort: 1238
          name: health
          protocol: TCP
        volumeMounts:
        - name: pacts-configmap-volume
          mountPath: /pacts-configmap
          readOnly: true
        - name: tmp-volume
          mountPath: /tmp
        livenessProbe:
          httpGet:
            path: /liveness
            port: 1238
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 3
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /readiness
            port: 1238
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            memory: 64Mi
            cpu: 50m
          limits:
            memory: 128Mi
            cpu: 100m

      volumes:
      - name: pacts-storage
        emptyDir: {}  # Ephemeral storage for CI/testing
      - name: pacts-configmap-volume
        configMap:
          name: pact-contracts
          optional: true  # ConfigMap may not exist if pact files haven't been generated yet
      - name: tmp-volume
        emptyDir: {}  # Temporary storage for manager flag file

---
# Services for each component
# Each service targets the same pod but different container ports

apiVersion: v1
kind: Service
metadata:
  name: pact-broker
  namespace: secret-manager-controller-pact-broker
  labels:
    app: pact-infrastructure
    component: pact-broker
    app.kubernetes.io/component: pact-broker
    app.kubernetes.io/part-of: secret-manager-controller
spec:
  type: ClusterIP
  ports:
  - port: 9292
    targetPort: 9292
    protocol: TCP
    name: http
  selector:
    app: pact-infrastructure

---
apiVersion: v1
kind: Service
metadata:
  name: mock-webhook
  namespace: secret-manager-controller-pact-broker
  labels:
    app: pact-infrastructure
    component: mock-webhook
    app.kubernetes.io/component: mock-webhook
    app.kubernetes.io/part-of: secret-manager-controller
spec:
  type: ClusterIP
  ports:
  - port: 1237
    targetPort: 1237
    protocol: TCP
    name: http
  selector:
    app: pact-infrastructure

---
apiVersion: v1
kind: Service
metadata:
  name: aws-mock-server
  namespace: secret-manager-controller-pact-broker
  labels:
    app: pact-infrastructure
    component: aws-mock-server
    provider: aws
    app.kubernetes.io/component: pact-mock-server
    app.kubernetes.io/part-of: secret-manager-controller
spec:
  type: ClusterIP
  ports:
  - port: 1234
    targetPort: 1235
    protocol: TCP
    name: http
  selector:
    app: pact-infrastructure

---
apiVersion: v1
kind: Service
metadata:
  name: gcp-mock-server
  namespace: secret-manager-controller-pact-broker
  labels:
    app: pact-infrastructure
    component: gcp-mock-server
    provider: gcp
    app.kubernetes.io/component: pact-mock-server
    app.kubernetes.io/part-of: secret-manager-controller
spec:
  type: ClusterIP
  ports:
  - port: 1234
    targetPort: 1235
    protocol: TCP
    name: http
  selector:
    app: pact-infrastructure

---
apiVersion: v1
kind: Service
metadata:
  name: azure-mock-server
  namespace: secret-manager-controller-pact-broker
  labels:
    app: pact-infrastructure
    component: azure-mock-server
    provider: azure
    app.kubernetes.io/component: pact-mock-server
    app.kubernetes.io/part-of: secret-manager-controller
spec:
  type: ClusterIP
  ports:
  - port: 1234
    targetPort: 1236
    protocol: TCP
    name: http
  selector:
    app: pact-infrastructure

